/*! d3.chart.candlestick - v0.0.3
 *  License: MIT Expat
 *  Date: 2013-06-30
 */
d3.chart("BaseCandlestickChart",{timestamp:function(t){return new Date(t).getTime()/1e3},widthForCandle:function(t){var n=t/10,e=(this.width()-this.margin.right)/(t+n)-2*this.strokeWidth-this.candleMargin;return e},heightForCandle:function(t,n){var e=t(Math.min(Number(n.open),Number(n.close)))-t(Math.max(Number(n.open),Number(n.close)));return 0>e?0:e},getStartingY:function(t){return Math.max(Number(t.open),Number(t.close))},initialize:function(t){t=t||{},this.exchange=t.exchange||"",this.ema=t.ema||!1;var n=this;this.x=d3.scale.linear(),this.y=d3.scale.linear(),this.base.attr("class","candlestick chart"),this.addGrid(n),this.addWicks(n),this.addOpenLines(n),this.addBars(n),this.addLastTrade(n),this.addInfo(n),this.addEma(n),this.width(t.width||900),this.height(t.height||300),this.strokeWidth=1,this.candleMargin=1,this.margin={top:0,bottom:0,left:0,right:60}},width:function(t){return arguments.length?(this.w=t,this.x.range([0,this.w]),this.base.attr("width",this.w),this):this.w},height:function(t){return arguments.length?(this.h=t,this.y.rangeRound([0,this.h]),this.base.attr("height",this.h),this):this.h},transform:function(t){var n;n=this.extractData(t);var e=d3.min(n.map(function(t){return new Date(t.open_time).getTime()/1e3})),i=d3.max(n.map(function(t){return new Date(t.open_time).getTime()/1e3})),r=d3.min(n.map(function(t){return Number(t.low)})),a=d3.max(n.map(function(t){return Number(t.high)})),s=.4*(a-r);return this.x.domain([e,i]).range([0,this.width()-this.margin.right]),this.y.domain([r-s,a+s]).range([this.height(),0]),n},extractData:function(t){var n;return n=t.data,t.ema&&n.forEach(function(n,e){t.ema[e]&&(n.ema=t.ema[e].price)}),n},addGrid:function(t){this.addGridY(t),this.addGridYLabels(t)},addGridY:function(t){function n(){this.attr("class","grid grid-y").attr("x1",0).attr("x2",t.width()-t.margin.right).attr("y1",t.y).attr("y2",t.y).attr("stroke-width",1)}function e(){this.duration(1e3).attr("y1",t.y).attr("y2",t.y)}function i(){this.duration(1e3).remove()}this.layer("grid-y",this.base.append("g"),{dataBind:function(){return this.selectAll("line.grid.grid-y").data(t.y.ticks(5))},insert:function(){return this.insert("line")}}),this.layer("grid-y").on("enter",n),this.layer("grid-y").on("update:transition",e),this.layer("grid-y").on("exit:transition",i)},addGridYLabels:function(t){function n(){this.attr("class","yLabel").attr("x",t.width()-t.margin.right).attr("y",t.y).attr("dy",5).attr("dx",20).attr("text-anchor","left").text(function(t){return t.toFixed(1)+""})}function e(){this.text(function(t){return t.toFixed(1)+""})}function i(){this.duration(1e3).attr("x",t.width()-t.margin.right).attr("y",t.y).attr("dy",5).attr("dx",20)}function r(){this.duration(1e3).remove()}this.layer("grid-y-labels",this.base.append("g"),{dataBind:function(){return this.selectAll("text.yLabel").data(t.y.ticks(5))},insert:function(){return this.insert("text")}}),this.layer("grid-y-labels").on("enter",n),this.layer("grid-y-labels").on("update",e),this.layer("grid-y-labels").on("update:transition",i),this.layer("grid-y-labels").on("exit:transition",r)},addLastTrade:function(t){this.addLastTradeLine(t),this.addLastTradeLabel(t)},addLastTradeLine:function(t){function n(){this.attr("class","last-trade-price").classed("fall",function(t){return Number(t.open)>Number(t.close)}).attr("x1",0).attr("x2",t.width()-t.margin.right).attr("y1",function(n){return t.y(Number(n.close))}).attr("y2",function(n){return t.y(Number(n.close))})}function e(){this.classed("fall",function(t){return Number(t.open)>Number(t.close)})}function i(){this.duration(1e3).attr("y1",function(n){return t.y(Number(n.close))}).attr("y2",function(n){return t.y(Number(n.close))})}function r(){this.remove()}function a(t){return this.selectAll("line.last-trade-price").data([t[t.length-1]],function(t){return t.open_time})}function s(){return this.insert("line")}this.layer("last-trade",this.base.append("g").attr("class","last-trade"),{dataBind:a,insert:s}),this.layer("last-trade").on("enter",n),this.layer("last-trade").on("update",e),this.layer("last-trade").on("update:transition",i),this.layer("last-trade").on("exit:transition",r)},addLastTradeLabel:function(t){function n(){this.attr("class","last-trade-label").classed("fall",function(t){return Number(t.open)>Number(t.close)}).attr("x",t.width()-t.margin.right).attr("y",function(n){return t.y(Number(n.close))}).attr("dy",5).attr("dx",20).attr("text-anchor","left").text(function(t){return Number(t.close).toFixed(1)+""})}function e(){this.classed("fall",function(t){return Number(t.open)>Number(t.close)}).text(function(t){return Number(t.close).toFixed(1)+""})}function i(){this.duration(1e3).attr("y",function(n){return t.y(Number(n.close))})}function r(){this.remove()}function a(t){return this.selectAll("text.last-trade-label").data([t[t.length-1]],function(t){return t.open_time})}function s(){return this.insert("text")}this.layer("last-trade-label",this.base.append("g").attr("class","last-trade-label"),{dataBind:a,insert:s}),this.layer("last-trade-label").on("enter",n),this.layer("last-trade-label").on("update",e),this.layer("last-trade-label").on("update:transition",i),this.layer("last-trade-label").on("exit:transition",r)},addWicks:function(t){function n(){var n=this.data().length;this.attr("class","wick").attr("x1",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("x2",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("y1",function(n){return t.y(Number(n.high))}).attr("y2",function(n){return t.y(Number(n.low))}).attr("width",1)}function e(){var n=this[0].length;this.duration(1e3).attr("x1",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("x2",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("y1",function(n){return t.y(Number(n.high))}).attr("y2",function(n){return t.y(Number(n.low))})}function i(){var n=this[0].length;this.duration(1e3).attr("x1",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("x2",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("y1",function(n){return t.y(Number(n.high))}).attr("y2",function(n){return t.y(Number(n.low))})}function r(){var n=this[0].length;this.duration(1e3).attr("x1",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("x2",function(e){return t.x(t.timestamp(e.open_time))+t.widthForCandle(n)/2}).attr("y1",function(n){return t.y(Number(n.high))}).attr("y2",function(n){return t.y(Number(n.low))}).remove()}function a(t){return this.selectAll("line.wick").data(t,function(t){return t.open_time})}function s(){return this.insert("line")}this.layer("wicks",this.base.append("g").attr("class","wicks"),{dataBind:a,insert:s}),this.layer("wicks").on("enter",n),this.layer("wicks").on("enter:transition",e),this.layer("wicks").on("update:transition",i),this.layer("wicks").on("exit:transition",r)},addEma:function(t){function n(){var t,n;this.attr("class","ema").attr("d",function(e){return t?(n=t,t=e,o([n,e])):(t=e,void 0)})}function e(){var t,n;this.duration(1e3).attr("d",function(e){return t?(n=t,t=e,o([n,e])):(t=e,void 0)})}function i(){var t,n;this.duration(1e3).attr("d",function(e){return t?(n=t,t=e,o([n,e])):(t=e,void 0)})}function r(){var t,n;this.duration(1e3).attr("d",function(e){return t?(n=t,t=e,o([n,e])):(t=e,void 0)}).remove()}function a(t){var n=[];return t.forEach(function(t){t.ema&&n.push(t)}),this.selectAll("path.ema").data(n,function(t){return t.open_time})}function s(){return this.insert("path")}var o=d3.svg.line().x(function(n){return t.x(t.timestamp(n.open_time))}).y(function(n){return n.ema?t.y(n.ema):t.y(0)});this.layer("ema",t.base.append("g").attr("class","ema"),{dataBind:a,insert:s}),this.layer("ema").on("enter",n),this.layer("ema").on("enter:transition",e),this.layer("ema").on("update:transition",i),this.layer("ema").on("exit:transition",r)},addOpenLines:function(t){function n(){var n=this.data().length;this.attr("class","open-line").attr("x",function(n){return t.x(t.timestamp(n.open_time))}).attr("y",function(n){return t.y(t.getStartingY(n))-t.strokeWidth}).attr("width",function(){return t.widthForCandle(n)}).attr("height",1)}function e(t){return this.selectAll("rect.open-line").data(t,function(t){return t.open_time})}function i(){return this.insert("rect")}function r(){this[0].length,this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5})}function a(){var n=this[0].length;this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5}).attr("y",function(n){return t.y(t.getStartingY(n))-t.strokeWidth}).attr("width",function(){return t.widthForCandle(n)})}function s(){this.remove()}this.layer("open-lines",this.base.append("g").attr("class","open-lines"),{dataBind:e,insert:i}),this.layer("open-lines").on("enter",n),this.layer("open-lines").on("enter:transition",r),this.layer("open-lines").on("update:transition",a),this.layer("open-lines").on("exit:transition",s)},addBars:function(){},getBarData:function(){},addInfo:function(t){this.layer("info",this.base.append("g").attr("class","info"),{dataBind:function(){return this.selectAll("rect").data([])},insert:function(){return this.insert("text")}});var n=d3.bisector(function(t){return new Date(t.open_time).getTime()/1e3}).left,e=function(){var n=150,e=115,i=15,r=6;t.layer("info").append("rect").attr("class","info").attr("width",n).attr("height",e).attr("x",0).attr("y",0);var a=t.layer("info").append("text").attr("class","info").attr("y",r).attr("x",r).attr("width",n-2*r).attr("height",e-2*r),s=i;a.append("tspan").attr("x",r).attr("y",s).text(t.exchange).attr("class","title"),s+=i;var o="";a.append("tspan").attr("x",r).attr("y",s).attr("class","date").text(o.toLocaleString()),s+=i,[["Open",""],["High",""],["Low",""],["Close",""],["Vol",""]].forEach(function(t){a.append("tspan").attr("class","titled-title "+t[0].toLowerCase()).attr("x",r).attr("y",s).text(t[0]+":"),a.append("tspan").attr("class","titled-data "+t[0].toLowerCase()).attr("dx",0).text(" "+t[1]),s+=i}),t.layer("info").append("line").attr("class","info line-x").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0),t.layer("info").append("line").attr("class","info line-y").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0),t.layer("info").style("display","none")};e(),this.base.on("mousemove",function(){t.layer("info").style("display","block");var e=d3.mouse(this)[0],i=d3.mouse(this)[1],r=t.x.invert(e),a=t.getBarData(t),s=n(a,r,1),o=a[s];if(t.layer("info").select("line.line-x").attr("x2",t.width()).attr("y1",i).attr("y2",i),t.layer("info").select("line.line-y").attr("x1",e).attr("x2",e).attr("y2",t.height()),o){var h=new Date(o.open_time);t.layer("info").select("tspan.date").text(h.toLocaleString()),[["Open",o.open],["High",o.high],["Low",o.low],["Close",o.close],["Vol",o.volume]].forEach(function(n){t.layer("info").select("tspan.titled-title."+n[0].toLowerCase()).text(n[0]+":"),t.layer("info").select("tspan.titled-data."+n[0].toLowerCase()).text(" "+n[1])})}}),this.base.on("mouseout",function(){var n=t.base[0][0].getBBox(),e=event.x<n.x||event.x>n.x+n.width,i=event.y<n.y||event.y>n.y+n.height;(i||e)&&t.layer("info").style("display","none")})}}),d3.chart("BaseCandlestickChart").extend("CandlestickChart",{addBars:function(t){function n(){var n=this.data().length;this.attr("class","candle").classed("fall",function(t){return Number(t.open)>Number(t.close)}).attr("x",function(n){return t.x(t.timestamp(n.open_time))}).attr("y",function(n){return t.y(t.getStartingY(n))-t.strokeWidth}).attr("width",function(){return t.widthForCandle(n)}).attr("height",function(n){return t.heightForCandle(t.y,n)}).attr("stroke-width",t.strokeWidth)}function e(){this[0].length,this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5})}function i(){this.classed("fall",function(t){return Number(t.open)>Number(t.close)})}function r(){this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5}).attr("y",function(n){return t.y(t.getStartingY(n))-t.strokeWidth}).attr("height",function(n){return t.heightForCandle(t.y,n)})}function a(){this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5}).remove()}function s(t){return this.selectAll("rect.candle").data(t,function(t){return t.open_time})}function o(){return this.insert("rect")}this.layer("bars",this.base.append("g").attr("class","bars"),{dataBind:s,insert:o}),this.layer("bars").on("enter",n),this.layer("bars").on("update",i),this.layer("bars").on("enter:transition",e),this.layer("bars").on("update:transition",r),this.layer("bars").on("exit:transition",a)},getBarData:function(t){return t.layer("bars").selectAll("rect.candle").data()}}),d3.chart("BaseCandlestickChart").extend("OHLCChart",{addBars:function(t){function n(n,e){return Number(n.open)>Number(n.close)?t.x(t.timestamp(n.open_time))+e:t.x(t.timestamp(n.open_time))}function e(){var e=this.data().length,i=t.widthForCandle(e)/2;this.attr("class","ohlc").classed("fall",function(t){return Number(t.open)>Number(t.close)}).attr("x",function(t){return n(t,i)}).attr("y",function(n){var e=t.heightForCandle(t.y,n);return t.y(t.getStartingY(n))-t.strokeWidth+e}).attr("width",i).attr("height",1)}function i(){var e=this[0].length,i=t.widthForCandle(e)/2;this.duration(1e3).attr("x",function(t){return n(t,i)})}function r(){this.classed("fall",function(t){return Number(t.open)>Number(t.close)})}function a(){var e=this[0].length,i=t.widthForCandle(e)/2;this.duration(1e3).attr("x",function(t){return n(t,i)}).attr("y",function(n){var e=t.heightForCandle(t.y,n);return t.y(t.getStartingY(n))-t.strokeWidth+e})}function s(){var n=this[0].length,e=t.widthForCandle(n)/2;this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))+e}).remove()}function o(t){return this.selectAll("rect.ohlc").data(t,function(t){return t.open_time})}function h(){return this.insert("rect")}this.layer("bars",this.base.append("g").attr("class","bars"),{dataBind:o,insert:h}),this.layer("bars").on("enter",e),this.layer("bars").on("update",r),this.layer("bars").on("enter:transition",i),this.layer("bars").on("update:transition",a),this.layer("bars").on("exit:transition",s)},getBarData:function(t){return t.layer("bars").selectAll("rect.ohlc").data()},addOpenLines:function(t){function n(n,e){return Number(n.open)>Number(n.close)?t.x(t.timestamp(n.open_time)):t.x(t.timestamp(n.open_time))+e}function e(){var e=this.data().length,i=t.widthForCandle(e)/2;this.attr("class","open-line").attr("x",function(t){return n(t,i)}).attr("y",function(n){return t.y(t.getStartingY(n))-t.strokeWidth}).attr("width",i).attr("height",1)}function i(t){return this.selectAll("rect.open-line").data(t,function(t){return t.open_time})}function r(){return this.insert("rect")}function a(){var e=this[0].length,i=t.widthForCandle(e)/2;this.duration(1e3).attr("x",function(t){return n(t,i)})}function s(){var e=this[0].length,i=t.widthForCandle(e)/2;this.duration(1e3).attr("x",function(t){return n(t,i)}).attr("y",function(n){return t.y(t.getStartingY(n))-t.strokeWidth}).attr("width",function(){return i})}function o(){this.remove()}this.layer("open-lines",this.base.append("g").attr("class","open-lines"),{dataBind:i,insert:r}),this.layer("open-lines").on("enter",e),this.layer("open-lines").on("enter:transition",a),this.layer("open-lines").on("update:transition",s),this.layer("open-lines").on("exit:transition",o)}}),d3.chart("VolumeChart",{timestamp:function(t){return new Date(t).getTime()/1e3},widthForBar:function(t){var n=t/10;return(this.width()-this.margin.right)/(t+n)-2*this.strokeWidth-this.candleMargin},heightForBar:function(t,n){var e=t(n.volume);return e},initialize:function(t){t=t||{};var n=this;this.x=d3.scale.linear(),this.y=d3.scale.linear(),this.base.attr("class","volume chart"),this.addBars(n),this.width(t.width||900),this.height(t.height||100),this.strokeWidth=1,this.candleMargin=1,this.margin={top:0,bottom:0,left:0,right:60}},width:function(t){return arguments.length?(this.w=t,this.x.range([0,this.w]),this.base.attr("width",this.w),this):this.w},height:function(t){return arguments.length?(this.h=t,this.y.rangeRound([0,this.h]),this.base.attr("height",this.h),this):this.h},transform:function(t){t=t.data;var n=d3.min(t.map(function(t){return new Date(t.open_time).getTime()/1e3})),e=d3.max(t.map(function(t){return new Date(t.open_time).getTime()/1e3}));d3.min(t.map(function(t){return Number(t.volume)}));var i=d3.max(t.map(function(t){return Number(t.volume)}));return this.x.domain([n,e]).range([0,this.width()-this.margin.right]),this.y.domain([0,i]).range([0,this.height()]),t},addBars:function(t){function n(){var n=this.data().length;this.attr("class","volume").classed("fall",function(t){return Number(t.open)>Number(t.close)}).attr("x",function(n){return t.x(t.timestamp(n.open_time))}).attr("y",function(n){return t.height()-t.heightForBar(t.y,n)}).attr("width",function(){return t.widthForBar(n)}).attr("height",function(n){return t.heightForBar(t.y,n)}).attr("fill","white")}function e(){this[0].length,this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5})}function i(){this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5}).attr("y",function(n){return t.height()-t.heightForBar(t.y,n)}).attr("height",function(n){return t.heightForBar(t.y,n)})}function r(){this.duration(1e3).attr("x",function(n){return t.x(t.timestamp(n.open_time))-.5}).remove()}function a(t){return this.selectAll("rect.volume").data(t,function(t){return t.open_time})}function s(){return this.insert("rect")}this.layer("bars",this.base.append("g").attr("class","bars"),{dataBind:a,insert:s}),this.layer("bars").on("enter",n),this.layer("bars").on("enter:transition",e),this.layer("bars").on("update:transition",i),this.layer("bars").on("exit:transition",r)}});