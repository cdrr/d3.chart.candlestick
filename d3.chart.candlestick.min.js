/*! d3.chart.candlestick - v0.0.1
 *  License: MIT Expat
 *  Date: 2013-06-23
 */
d3.chart("CandlestickChart",{initialize:function(t){function e(){var t=this.data().length;this.attr("class","candle").classed("fall",function(t){return Number(t.open)>Number(t.close)}).attr("x",function(t){return v.x(w(t.open_time))}).attr("y",function(t){return v.y(l(t))}).attr("width",function(){return f(t)}).attr("height",function(t){return d(v.y,t)}).attr("stroke-width",v.strokeWidth)}function n(){var t=this.data().length;this.attr("class","open-line").attr("x",function(t){return v.x(w(t.open_time))}).attr("y",function(t){return v.y(l(t))}).attr("width",function(){return f(t)}).attr("height",1)}function i(){this[0].length,this.duration(1e3).attr("x",function(t){return v.x(w(t.open_time))-.5})}function r(){this.duration(1e3).attr("x",function(t){return v.x(w(t.open_time))-.5})}function a(){this.duration(1e3).attr("x",function(t){return v.x(w(t.open_time))-.5}).remove()}function s(){this.duration(1e3).attr("x",function(t){return v.x(w(t.open_time))-.5}).remove()}function o(){var t=this.data().length;this.attr("class","wick").attr("x1",function(e){return v.x(w(e.open_time))+f(t)/2}).attr("x2",function(e){return v.x(w(e.open_time))+f(t)/2}).attr("y1",function(t){return v.y(Number(t.high))}).attr("y2",function(t){return v.y(Number(t.low))}).attr("width",1)}function h(){var t=this[0].length;this.duration(1e3).attr("x1",function(e){return v.x(w(e.open_time))+f(t)/2}).attr("x2",function(e){return v.x(w(e.open_time))+f(t)/2})}function u(){var t=this[0].length;this.duration(1e3).attr("x1",function(e){return v.x(w(e.open_time))+f(t)/2}).attr("x2",function(e){return v.x(w(e.open_time))+f(t)/2})}function c(){var t=this[0].length;this.duration(1e3).attr("x1",function(e){return v.x(w(e.open_time))+f(t)/2}).attr("x2",function(e){return v.x(w(e.open_time))+f(t)/2}).remove()}function l(t){return Math.max(Number(t.open),Number(t.close))}function d(t,e){var n=t(Math.min(Number(e.open),Number(e.close)))-t(Math.max(Number(e.open),Number(e.close))),i=n-2*v.strokeWidth;return 0>i?0:i}function f(t){return(v.width()-v.margin.right)/t-2*v.strokeWidth-v.candleMargin}function p(t){return this.selectAll("rect.candle").data(t,function(t){return t.open_time})}function m(t){return this.selectAll("rect.open-line").data(t,function(t){return t.open_time})}function x(t){return this.selectAll("line.wick").data(t,function(t){return t.open_time})}function g(){return this.insert("rect")}function y(){return this.insert("rect")}function b(){return this.insert("line")}function w(t){return new Date(t).getTime()/1e3}t=t||{};var v=this;this.x=d3.scale.linear(),this.y=d3.scale.linear(),this.base.attr("class","chart"),this.layer("grid-y",this.base.append("g"),{dataBind:function(){return this.selectAll("line.grid.grid-y").data(v.y.ticks(10))},insert:function(){return this.insert("line").attr("class","grid grid-y").attr("x1",0).attr("x2",v.width()-v.margin.right).attr("y1",v.y).attr("y2",v.y).attr("stroke-width",1)}}),this.layer("grid-y-labels",this.base.append("g"),{dataBind:function(){return this.selectAll("text.yLabel").data(v.y.ticks(5))},insert:function(){return this.insert("text").attr("class","yLabel").attr("x",v.width()-v.margin.right).attr("y",v.y).attr("dy",5).attr("dx",20).attr("text-anchor","left").text(function(t){return t.toFixed(1)+""})}}),this.layer("wicks",this.base.append("g").attr("class","wicks"),{dataBind:x,insert:b}),this.layer("open-lines",this.base.append("g").attr("class","open-lines"),{dataBind:m,insert:g}),this.layer("bars",this.base.append("g").attr("class","bars"),{dataBind:p,insert:y}),this.layer("info",this.base.append("g").attr("class","info"),{dataBind:function(){return this.selectAll("rect").data([])},insert:function(){return this.insert("text")}}),this.layer("open-lines").on("enter",n),this.layer("open-lines").on("enter:transition",i),this.layer("open-lines").on("update:transition",r),this.layer("open-lines").on("exit:transition",s),this.layer("bars").on("enter",e),this.layer("bars").on("enter:transition",i),this.layer("bars").on("update:transition",r),this.layer("bars").on("exit:transition",a),this.layer("wicks").on("enter",o),this.layer("wicks").on("enter:transition",h),this.layer("wicks").on("update:transition",u),this.layer("wicks").on("exit:transition",c);var _=d3.bisector(function(t){return new Date(t.open_time).getTime()/1e3}).left;this.base.on("mouseover",function(){v.base.selectAll("rect.info").remove(),v.base.selectAll("text.info").remove();var t=v.x.invert(d3.mouse(this)[0]),e=v.layer("bars").selectAll("rect.candle").data(),n=_(e,t,1),i=e[n],r=125,a=115;if(i){var s=15,o=6;v.layer("info").append("rect").attr("class","info").attr("width",r).attr("height",a).attr("x",0).attr("y",0);var h=v.layer("info").append("text").attr("class","info").attr("y",o).attr("x",o).attr("width",r-2*o).attr("height",a-2*o),u=s;h.append("tspan").attr("x",o).attr("y",u).text("Mt. Gox").attr("class","title"),u+=s;var c=new Date(i.open_time);h.append("tspan").attr("x",o).attr("y",u).attr("class","date").text(c.toLocaleString()),u+=s,[["Open",i.open],["High",i.high],["Low",i.low],["Close",i.close],["Vol",i.volume]].forEach(function(t){h.append("tspan").attr("class","titled-title").attr("x",o).attr("y",u).text(t[0]+":"),h.append("tspan").attr("class","titled-data").attr("dx",0).text(" "+t[1]),u+=s})}}),this.base.on("mouseout",function(){var t=v.base[0][0].getBBox(),e=event.x<t.x||event.x>t.x+t.width,n=event.y<t.y||event.y>t.y+t.height;(n||e)&&(v.base.selectAll("rect.info").remove(),v.base.selectAll("text.info").remove())}),this.width(t.width||900),this.height(t.height||300),this.strokeWidth=1,this.candleMargin=1,this.margin={top:0,bottom:0,left:0,right:60}},width:function(t){return arguments.length?(this.w=t,this.x.range([0,this.w]),this.base.attr("width",this.w),this):this.w},height:function(t){return arguments.length?(this.h=t,this.y.rangeRound([0,this.h]),this.base.attr("height",this.h),this):this.h},transform:function(t){t=t.data;var e=d3.min(t.map(function(t){return new Date(t.open_time).getTime()/1e3})),n=d3.max(t.map(function(t){return new Date(t.open_time).getTime()/1e3})),i=d3.min(t.map(function(t){return Number(t.low)})),r=d3.max(t.map(function(t){return Number(t.high)})),a=.4*(r-i);return this.x.domain([e,n]).range([0,this.width()-this.margin.right]),this.y.domain([i-a,r+a]).range([this.height(),0]),t}});